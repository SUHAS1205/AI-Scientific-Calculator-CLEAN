<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalcAI - FX Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        page: { 50: '#f8fafc', 100: '#f1f5f9', 800: '#1e293b', 600: '#475569' },
                        brand: { 50: '#ecfdf5', 100: '#d1fae5', 400: '#34d399', 500: '#10b981', 600: '#059669', 700: '#047857', 900: '#064e3b' }
                    }
                }
            }
        }
    </script>
    <style>
        html { scroll-behavior: smooth; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .calc-btn:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-gray-50 text-page-600 font-sans antialiased flex flex-col min-h-screen">
    
    {% include 'nav.html' %}

    <main class="pt-28 pb-24 flex-grow">
        
        <div class="max-w-7xl mx-auto px-6 lg:px-8">
            
            <div class="text-center mb-10">
                <div class="inline-flex items-center bg-brand-100 text-brand-700 px-4 py-2 rounded-full text-sm font-semibold mb-4 border border-brand-200">
                    <span class="w-2 h-2 bg-brand-500 rounded-full mr-2 animate-pulse"></span>
                    <i class="fas fa-microphone mr-2"></i> AI Math Engine
                </div>
                <h1 class="text-4xl md:text-5xl font-extrabold text-page-800 mb-4">AI Scientific Calculator</h1>
            </div>

            <div class="grid lg:grid-cols-12 gap-8 items-start">
                
                <div class="lg:col-span-7 flex flex-col gap-6">
                    <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden relative">
                        
                        <div class="bg-gradient-to-r from-brand-500 to-brand-600 p-6 text-white">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold"><i class="fas fa-calculator mr-2"></i>Calculator</h2>
                                <div class="flex space-x-2">
                                    <button id="voiceBtn" class="bg-white/20 hover:bg-white/30 p-2 rounded transition"><i class="fas fa-microphone"></i></button>
                                    <button id="clearAllBtn" class="bg-white/20 hover:bg-white/30 p-2 rounded transition"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                            
                            <div class="relative">
                                <textarea id="expressionInput" rows="2" class="w-full px-4 py-3 bg-white/20 border-2 border-white/30 rounded-xl focus:bg-white/30 focus:outline-none transition resize-none text-2xl text-white placeholder-white/60 font-mono text-right" placeholder="0"></textarea>
                                <div id="voiceStatus" class="hidden mt-2 text-sm flex items-center justify-end"><i class="fas fa-circle-notch fa-spin mr-2"></i> Listening...</div>
                            </div>
                        </div>

                        <div class="p-6 bg-gray-50 relative">
                            
                            <div class="flex justify-end mb-4 h-6">
                                <span id="localPreview" class="text-gray-400 font-mono text-sm font-bold"></span>
                            </div>

                            <div class="grid grid-cols-5 gap-2">
                                <button class="calc-btn calc-btn-special py-3 bg-gray-200 rounded hover:bg-gray-300 font-bold text-gray-700" data-func="sin">sin</button>
                                <button class="calc-btn calc-btn-special py-3 bg-gray-200 rounded hover:bg-gray-300 font-bold text-gray-700" data-func="cos">cos</button>
                                <button class="calc-btn calc-btn-special py-3 bg-gray-200 rounded hover:bg-gray-300 font-bold text-gray-700" data-func="tan">tan</button>
                                <button class="calc-btn calc-btn-special py-3 bg-gray-200 rounded hover:bg-gray-300 font-bold text-gray-700" data-func="log">log</button>
                                <button class="calc-btn calc-btn-special py-3 bg-gray-200 rounded hover:bg-gray-300 font-bold text-gray-700" data-func="ln">ln</button>

                                <button class="calc-btn calc-btn-special py-3 bg-gray-200 rounded hover:bg-gray-300 font-bold text-gray-700" data-func="sqrt">√</button>
                                <button class="calc-btn calc-btn-special py-3 bg-gray-200 rounded hover:bg-gray-300 font-bold text-gray-700" data-func="pow">x²</button>
                                <button class="calc-btn calc-btn-special py-3 bg-gray-200 rounded hover:bg-gray-300 font-bold text-gray-700" data-func="^">^</button>
                                <button class="calc-btn calc-btn-special py-3 bg-gray-200 rounded hover:bg-gray-300 font-bold text-gray-700" data-value="(">(</button>
                                <button class="calc-btn calc-btn-special py-3 bg-gray-200 rounded hover:bg-gray-300 font-bold text-gray-700" data-value=")">)</button>

                                <button class="calc-btn py-3 bg-red-100 text-red-600 rounded hover:bg-red-200 font-bold" data-action="clear">AC</button>
                                <button class="calc-btn py-3 bg-red-100 text-red-600 rounded hover:bg-red-200 font-bold" data-action="backspace">⌫</button>
                                <button class="calc-btn py-3 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 font-bold" data-func="pi">π</button>
                                <button class="calc-btn py-3 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 font-bold" data-func="e">e</button>
                                <button class="calc-btn py-3 bg-brand-100 text-brand-700 rounded hover:bg-brand-200 font-bold text-lg" data-value="/">÷</button>

                                <button class="calc-btn py-3 bg-white border border-gray-200 rounded shadow-sm hover:bg-gray-50 text-xl font-bold text-gray-800" data-value="7">7</button>
                                <button class="calc-btn py-3 bg-white border border-gray-200 rounded shadow-sm hover:bg-gray-50 text-xl font-bold text-gray-800" data-value="8">8</button>
                                <button class="calc-btn py-3 bg-white border border-gray-200 rounded shadow-sm hover:bg-gray-50 text-xl font-bold text-gray-800" data-value="9">9</button>
                                <button class="calc-btn py-3 bg-brand-100 text-brand-700 rounded hover:bg-brand-200 font-bold text-lg" data-value="*">×</button>
                                <button class="calc-btn py-3 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 font-bold" data-func="factorial">n!</button>

                                <button class="calc-btn py-3 bg-white border border-gray-200 rounded shadow-sm hover:bg-gray-50 text-xl font-bold text-gray-800" data-value="4">4</button>
                                <button class="calc-btn py-3 bg-white border border-gray-200 rounded shadow-sm hover:bg-gray-50 text-xl font-bold text-gray-800" data-value="5">5</button>
                                <button class="calc-btn py-3 bg-white border border-gray-200 rounded shadow-sm hover:bg-gray-50 text-xl font-bold text-gray-800" data-value="6">6</button>
                                <button class="calc-btn py-3 bg-brand-100 text-brand-700 rounded hover:bg-brand-200 font-bold text-lg" data-value="-">−</button>
                                <button class="calc-btn py-3 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 font-bold" data-func="abs">|x|</button>

                                <button class="calc-btn py-3 bg-white border border-gray-200 rounded shadow-sm hover:bg-gray-50 text-xl font-bold text-gray-800" data-value="1">1</button>
                                <button class="calc-btn py-3 bg-white border border-gray-200 rounded shadow-sm hover:bg-gray-50 text-xl font-bold text-gray-800" data-value="2">2</button>
                                <button class="calc-btn py-3 bg-white border border-gray-200 rounded shadow-sm hover:bg-gray-50 text-xl font-bold text-gray-800" data-value="3">3</button>
                                <button class="calc-btn py-3 bg-brand-100 text-brand-700 rounded hover:bg-brand-200 font-bold text-lg" data-value="+">+</button>
                                <button class="calc-btn py-3 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 font-bold" data-func="percent">%</button>

                                <button class="calc-btn py-3 col-span-2 bg-white border border-gray-200 rounded shadow-sm hover:bg-gray-50 text-xl font-bold text-gray-800" data-value="0">0</button>
                                <button class="calc-btn py-3 bg-white border border-gray-200 rounded shadow-sm hover:bg-gray-50 text-xl font-bold text-gray-800" data-value=".">.</button>
                                <button class="calc-btn py-3 col-span-2 bg-brand-600 text-white rounded hover:bg-brand-700 font-bold text-2xl shadow-lg shadow-brand-500/30" data-action="calculate">=</button>
                            </div>

                            <button id="calculateBtn" class="w-full mt-4 bg-gray-800 hover:bg-gray-900 text-white py-3 rounded-xl font-bold shadow-lg transition flex items-center justify-center">
                                <i class="fas fa-brain mr-2"></i> Process / Graph (AI)
                            </button>
                        </div>
                        
                        <div id="loadingState" class="hidden absolute inset-0 flex items-center justify-center z-50 pointer-events-none">
                            <div class="bg-white shadow-2xl border border-gray-200 rounded-2xl px-8 py-6 flex flex-col items-center">
                                <i class="fas fa-circle-notch fa-spin text-4xl text-brand-500 mb-2"></i>
                                <p class="font-bold text-gray-700">Calculating...</p>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="lg:col-span-5 flex flex-col gap-6">
                    
                    <div id="resultSection" class="hidden bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden w-full">
                        <div class="bg-brand-50 border-l-8 border-brand-500 p-8">
                            <div class="flex justify-between mb-4">
                                <h3 class="text-2xl font-bold text-brand-800">Result</h3>
                                <div class="flex gap-2">
                                    <button id="speakBtn" class="text-brand-600 hover:text-brand-800 transition"><i class="fas fa-volume-up fa-2x"></i></button>
                                    <button id="copyBtn" class="text-brand-600 hover:text-brand-800 transition"><i class="fas fa-copy fa-2x"></i></button>
                                </div>
                            </div>
                            
                            <div id="resultText" class="text-4xl font-bold text-brand-900 break-words mb-6"></div>
                            <div id="expressionDisplay" class="text-sm text-gray-500 font-mono mb-4"></div>
                            
                            <div id="graphContainer" class="hidden w-full h-[500px] bg-white rounded-xl border border-gray-200 shadow-inner"></div>
                        </div>
                    </div>

                    <div id="errorSection" class="hidden bg-red-50 border-l-8 border-red-500 p-8 rounded-2xl shadow-lg w-full">
                        <h3 class="text-red-800 font-bold mb-2 text-xl"><i class="fas fa-exclamation-triangle mr-2"></i>Error</h3>
                        <div id="errorText" class="text-red-600 text-lg"></div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 w-full">
                        <h3 class="font-bold text-gray-700 mb-4 text-lg"><i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Try These Examples</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button class="example-btn w-full text-left p-3 bg-gray-50 hover:bg-brand-50 rounded-xl border border-gray-100 transition font-medium">Graph sin(x)</button>
                            <button class="example-btn w-full text-left p-3 bg-gray-50 hover:bg-brand-50 rounded-xl border border-gray-100 transition font-medium">Solve x^2 - 4 = 0</button>
                            <button class="example-btn w-full text-left p-3 bg-gray-50 hover:bg-brand-50 rounded-xl border border-gray-100 transition font-medium">Derivative of x^2</button>
                            <button class="example-btn w-full text-left p-3 bg-gray-50 hover:bg-brand-50 rounded-xl border border-gray-100 transition font-medium">Integral of 2x</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    {% include 'footer.html' %}

    <script>
        const el = {
            input: document.getElementById('expressionInput'),
            preview: document.getElementById('localPreview'),
            resultSec: document.getElementById('resultSection'),
            resultTxt: document.getElementById('resultText'),
            exprDisplay: document.getElementById('expressionDisplay'),
            graphBox: document.getElementById('graphContainer'),
            errorSec: document.getElementById('errorSection'),
            errorTxt: document.getElementById('errorText'),
            loading: document.getElementById('loadingState'),
            mainBtn: document.getElementById('calculateBtn'),
            voiceBtn: document.getElementById('voiceBtn'),
            status: document.getElementById('voiceStatus'),
            copy: document.getElementById('copyBtn'),
            speak: document.getElementById('speakBtn'),
            clear: document.getElementById('clearAllBtn')
        };

        function factorial(n) {
            if (n < 0) return NaN;
            if (n === 0 || n === 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) result *= i;
            return result;
        }

        function tryLocalMath(expression) {
            try {
                let expr = expression
                    .replace(/×/g, '*')
                    .replace(/÷/g, '/')
                    .replace(/−/g, '-')
                    .replace(/π/g, Math.PI)
                    .replace(/e/g, Math.E)
                    .replace(/sin\(/g, 'Math.sin(')
                    .replace(/cos\(/g, 'Math.cos(')
                    .replace(/tan\(/g, 'Math.tan(')
                    .replace(/log\(/g, 'Math.log10(')
                    .replace(/ln\(/g, 'Math.log(')
                    .replace(/√\(/g, 'Math.sqrt(')
                    .replace(/√(\d+)/g, 'Math.sqrt($1)')
                    .replace(/\^/g, '**')
                    .replace(/(\d+)!/g, (m, n) => factorial(parseInt(n)));

                if (/[a-df-mo-z]/.test(expr.replace(/Math/g, ''))) return null; 

                const result = eval(expr);
                if (isNaN(result) || !isFinite(result)) return null;
                
                return Math.round(result * 100000000) / 100000000;
            } catch (e) {
                return null;
            }
        }

        function updatePreview() {
            const val = el.input.value;
            const localRes = tryLocalMath(val);
            el.preview.innerText = (localRes !== null && val.trim() !== "") ? `= ${localRes}` : "";
        }

        function showResult(text, isGraph = false) {
            el.resultSec.classList.remove('hidden');
            el.errorSec.classList.add('hidden');
            el.resultTxt.innerHTML = text;
            el.exprDisplay.innerText = el.input.value;
            
            if (!isGraph) {
                el.graphBox.classList.add('hidden');
                speakText(text);
            } else {
                speakText("Here is the graph.");
            }
        }

        function showError(msg) {
            el.errorSec.classList.remove('hidden');
            el.resultSec.classList.add('hidden');
            el.errorTxt.innerText = msg;
            speakText("Error: " + msg);
        }

        document.querySelectorAll('.calc-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const val = btn.dataset.value;
                const func = btn.dataset.func;
                const action = btn.dataset.action;

                if (val) insertAtCursor(val);
                else if (func) {
                    if (['sin','cos','tan','log','ln','sqrt'].includes(func)) insertAtCursor(func + '(');
                    else if (func === 'pow') insertAtCursor('^2');
                    else if (func === 'factorial') insertAtCursor('!');
                    else if (func === 'abs') insertAtCursor('abs(');
                    else if (func === 'percent') insertAtCursor('%');
                    else insertAtCursor(btn.innerText); 
                } 
                else if (action === 'clear') {
                    el.input.value = '';
                    resetUI();
                } 
                else if (action === 'backspace') {
                    el.input.value = el.input.value.slice(0, -1);
                } 
                else if (action === 'calculate') {
                    processCalculation();
                }
                
                updatePreview();
                el.input.focus();
            });
        });

        function insertAtCursor(text) {
            const start = el.input.selectionStart;
            const end = el.input.selectionEnd;
            const val = el.input.value;
            el.input.value = val.substring(0, start) + text + val.substring(end);
            el.input.selectionStart = el.input.selectionEnd = start + text.length;
        }

        function resetUI() {
            el.resultSec.classList.add('hidden');
            el.errorSec.classList.add('hidden');
            el.graphBox.classList.add('hidden');
            el.preview.innerText = "";
        }

        async function processCalculation() {
            const expression = el.input.value.trim();
            if (!expression) return;

            const localResult = tryLocalMath(expression);
            
            if (localResult !== null) {
                showResult(localResult);
                return;
            }

            el.loading.classList.remove('hidden');
            resetUI();

            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ expression: expression })
                });
                const data = await response.json();
                
                el.loading.classList.add('hidden');

                if (data.status === 'success') {
                    if (data.type === 'graph') {
                        showResult('<span class="text-brand-600">Graph Generated</span>', true);
                        renderGraph(data.graph_data);
                    } else {
                        showResult(data.result);
                    }
                } else {
                    showError(data.message || 'Calculation failed');
                }
            } catch (err) {
                el.loading.classList.add('hidden');
                showError("Network error. Please try again.");
            }
        }

        function renderGraph(data) {
            const trace = {
                x: data.x,
                y: data.y,
                mode: 'lines',
                line: {color: '#10b981', width: 3},
                name: data.equation
            };
            const layout = {
                margin: {t: 20, r: 20, l: 40, b: 40},
                xaxis: {gridcolor: '#f3f4f6'},
                yaxis: {gridcolor: '#f3f4f6'}
            };
            el.graphBox.classList.remove('hidden');
            Plotly.newPlot('graphContainer', [trace], layout, {responsive: true, displayModeBar: false});
        }

        el.mainBtn.addEventListener('click', processCalculation);
        el.input.addEventListener('input', updatePreview);
        el.input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                processCalculation();
            }
        });
        el.clear.addEventListener('click', () => {
            el.input.value = '';
            resetUI();
        });

        function speakText(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const div = document.createElement('div');
                div.innerHTML = text;
                const cleanText = div.textContent || div.innerText || "";
                const utterance = new SpeechSynthesisUtterance(cleanText);
                window.speechSynthesis.speak(utterance);
            }
        }
        el.speak.addEventListener('click', () => speakText(el.resultTxt.innerHTML));

        el.copy.addEventListener('click', () => {
            const div = document.createElement('div');
            div.innerHTML = el.resultTxt.innerHTML;
            navigator.clipboard.writeText(div.textContent || "");
        });

        if ('webkitSpeechRecognition' in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            el.voiceBtn.addEventListener('click', () => {
                recognition.start();
                el.status.classList.remove('hidden');
            });
            recognition.onresult = (e) => {
                el.input.value = e.results[0][0].transcript;
                el.status.classList.add('hidden');
                processCalculation();
            };
            recognition.onend = () => el.status.classList.add('hidden');
        } else {
            el.voiceBtn.style.display = 'none';
        }

        document.querySelectorAll('.example-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                el.input.value = btn.innerText;
                processCalculation();
            });
        });
    </script>
</body>
</html>